<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="assets/images/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/images/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Epiroc Dashboard
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css"
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="assets/css/material-dashboard.css?v=2.1.1" rel="stylesheet" />
</head>

<body class="dark-edition">
<div class="wrapper">
  <div class="">
  <!--   Content   -->
    <div class="content">
      <div class="container-fluid" style="padding-top:15px">
        <div class="row row-container" style="padding-top:5px">
          <div class="col-xs-2 col-xl-2 col-lg-2 card-container pad pl-3">
            <div class="card ">
              <div class="card-body text-center">
                <img src="images/park-disabled.png" class="img-small" id="park-img">
              </div>
            </div>
          </div>
          <div class="col-xs-2 col-xl-2 col-lg-2 card-container  pad">
            <div class="card ">
              <div class="card-body text-center">
                <img src="images/check-engine.PNG" class="img-small" id="check-engine">
              </div>
            </div>
          </div>
          <div class="col-xs-2 col-xl-2 col-lg-2 card-container  pad">
            <div class="card ">
              <div class="card-body text-center">
                <img src="images/power.png" class="img-small blink-image" id="motor-status">
              </div>
            </div>
          </div>
          <div class="col-xs-2 col-xl-2 col-lg-2 card-container  pad">
            <div class="card ">
              <div class="card-body text-center">
                 <img src="images/battery.png" alt="Battery" class="img-small blink-image" id="battery-low" />
              </div>
            </div>
          </div>
        </div>
        <div class="row row-container margin-60" >
          <div class="col-lg-12 pl-3 pr-3">
            <div class="card card-meter " >
              <div class="card-body text-center" >
                <div class="d-flex flex-wrap justify-content-lg-around">
                  <!--     Speedometer     -->
                  <canvas id="canvas-id" data-type="radial-gauge" data-width="350" data-height="350" data-units="kW"
                    data-min-value="-500" data-max-value="500" data-major-ticks="[-300,-200,-100,0,100,200,300]"
                    data-minor-ticks="2" data-stroke-ticks="true" data-highlights='[ {"from": -300, "to": 0, "color": "rgba(0,0, 255, .3)"},
                   {"from": 0, "to": 300, "color": "rgba(255, 0, 0, .3)"} ]' data-ticks-angle="225"
                    data-start-angle="67.5" data-color-major-ticks="#ddd" data-color-minor-ticks="#ddd"
                    data-color-title="#eee" data-color-units="#ccc" data-color-numbers="#eee" data-color-plate="#222"
                    data-border-shadow-width="0" data-borders="true" data-needle-type="arrow" data-needle-width="2"
                    data-needle-circle-size="7" data-needle-circle-outer="true" data-needle-circle-inner="false"
                    data-animation-duration="1500" data-animation-rule="linear" data-color-border-outer="#333"
                    data-color-border-outer-end="#111" data-color-border-middle="#222"
                    data-color-border-middle-end="#111" data-color-border-inner="#111"
                    data-color-border-inner-end="#333" data-color-needle-shadow-down="#333"
                    data-color-needle-circle-outer="#333" data-color-needle-circle-outer-end="#111"
                    data-color-needle-circle-inner="#111" data-color-needle-circle-inner-end="#222"
                    data-value-box-border-radius="0" data-color-value-box-rect="#222"
                    data-color-value-box-rect-end="#333" data-font-value="Led" data-font-numbers="Led"
                    data-font-title="Led" data-font-units="" width="350" height="350"></canvas>

                  <canvas id="canvas-2" data-type="radial-gauge" data-width="350" data-height="350" data-units="kW"
                    data-min-value="0" data-max-value="800" data-major-ticks="[0,100,200,300,400,500,600,700,800]"
                    data-minor-ticks="2" data-stroke-ticks="true"
                    data-highlights='[ {"from": 500, "to": 800, "color": "rgba(255, 0, 0, .3)"} ]'
                    data-ticks-angle="225" data-start-angle="67.5" data-color-major-ticks="#ddd"
                    data-color-minor-ticks="#ddd" data-color-title="#eee" data-color-units="#ccc"
                    data-color-numbers="#eee" data-color-plate="#222" data-border-shadow-width="0" data-borders="true"
                    data-needle-type="arrow" data-needle-width="2" data-needle-circle-size="7"
                    data-needle-circle-outer="true" data-needle-circle-inner="false" data-animation-duration="1500"
                    data-animation-rule="linear" data-color-border-outer="#333" data-color-border-outer-end="#111"
                    data-color-border-middle="#222" data-color-border-middle-end="#111" data-color-border-inner="#111"
                    data-color-border-inner-end="#333" data-color-needle-shadow-down="#333"
                    data-color-needle-circle-outer="#333" data-color-needle-circle-outer-end="#111"
                    data-color-needle-circle-inner="#111" data-color-needle-circle-inner-end="#222"
                    data-value-box-border-radius="0" data-color-value-box-rect="#222"
                    data-color-value-box-rect-end="#333" data-font-value="Led" data-font-numbers="Led"
                    data-font-title="Led" data-font-units="" width="350" height="350"></canvas>
                     <!--     Speedometer  End   -->
                </div>

              </div>
            </div>
          </div>
        </div>
        <div class="row row-container" style="margin-top:-62px;">
          <div class="col-lg-7">
            <div class="row">
              <div class="col-xl-3 col-lg-3 pad pl-3">
                <div class="card min-160">
                  <div class="card-body text-center p-3 ">
                    <img src="images/gear.PNG">
                    <strong>
                      <div class="mt-2 percentage" id="gear_ratio">n/n</div>
                    </strong>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-lg-3 pad">
                <div class="card min-160">
                  <div class="card-body text-center p-3 ">
                    <div class="battery-container mt-3 mb-0">
                      <div class="battery-head"></div>
                      <div class="battery">
                        <div class="battery-block block-1"></div>
                        <div class="battery-block block-2"></div>
                        <div class="battery-block block-3"></div>
                        <div class="battery-block block-4"></div>
                        <div class="battery-block block-5"></div>
                      </div>
                    </div>
                    <p class="mb-0 mt-2"><span class="percentage " id="percent"></span><span class="percentage ">
                        %</span></p>

                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-lg-3 pad">
                <div class="card min-160">
                  <div class="card-body text-center p-3">
                    <div class="battery-container mt-3" style="margin-left:-3px;">
                      <div class="battery-head"></div>
                      <div class="battery">

                      </div>
                      <div class="temp-div">
                        <canvas id="canvas-3" data-type="linear-gauge" data-width="60" data-height="110" data-units="°C"
                          data-min-value="0" data-start-angle="90" data-ticks-angle="180" data-value-box="false"
                          data-max-value="60" data-major-ticks="0,20,40,60" data-minor-ticks="2"
                          data-stroke-ticks="true"
                          data-highlights='[ {"from": 40, "to": 60, "color": "rgba(200, 50, 50, .75)"} ]'
                          data-color-plate="#15151500" data-border-shadow-width="0" data-borders="false"
                          data-needle-type="arrow" data-needle-width="6" data-needle-circle-size="7"
                          data-needle-circle-outer="true" data-needle-circle-inner="true" data-animation-duration="500"
                          data-animation-rule="linear" data-bar-width="8" data-value="35" data-tick-side="right"
                          data-number-side="right" data-needle-side="right"></canvas>
                      </div>
                      <!-- Overlay percentage -->

                    </div>
                    <p class="mt-2 mb-0"><span class=" percentage" id="temp"></span><span>°C</span></p>

                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-lg-3 pad">
                <div class="card min-160">
                  <div class="card-body text-center p-3">
                    <img src="images/power.PNG">
                    <strong>
                      <div class="percentage" id="rpm">0.0 RPM</div>
                    </strong>

                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-5 col-lg-5 pad pr-3">
            <div class="card ">
              <div class="card-body text-center" style="min-height:154px;">

                <div class="slider-container">
                  <div class="slider-title">MOTOR SPEEDING METER</div>
                  <span id="speedoMeterInputRange-value-1" style="display:none"></span>
                  <input id="animated-slider" type="range" min="0" max="800" value="0" step="100">

                  <div class="markers">
                    <span>Off</span>
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>

                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="row row-container justify-content-lg-between div-last">
          <div class="col-lg-5 d-flex flex-wrap justify-content-lg-start">
            <div class="row" style="width:78%">
              <div class="col-xl-4 col-lg-4 text-center pad pl-3">
                <div class="card ">
                  <div class="card-body ">
                    <img src="images/gear.PNG" class="img-med">
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-lg-4 pad">
                <div class="card ">
                  <div class="card-body text-center ">
                    <img src="images/power-disabled.png" class="img-med">
                  </div>
                </div>
              </div>
              <div class="col-xl-4 col-lg-4 pad pr-3">
                <div class="card">
                  <div class="card-body text-center ">
                    <img src="images/temp.PNG" class="img-med">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xl-2 col-lg-2 d-flex justify-content-center pad" style="margin-left:-23%">
            <div class="card">
              <div class="card-body text-center">
                <img src="images/menu.png" class="img-med">
              </div>
            </div>
          </div>

          <div class="col-xl-2 col-lg-2 d-flex justify-content-center pad pr-3">
            <div class="card btn">
              <div class="card-body text-center">
                <img src="images/plugin-disabled.png" class="img-med" id="plugin">
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

<!--   Content End   -->
  </div>
</div>

<!--   Core JS Files   -->
<script src="assets/js/jquery.min.js"></script>

<script src="assets/js/gauge.min.js"></script>
<script src="assets/js/main.js"></script>
<script type="module" src="assets/js/firebase.js">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getFirestore,doc, collection,getDoc, onSnapshot,updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyD_vTacVZzxVziS0e95Fi5JTMHq1DT_m0U",
    authDomain: "epiroc-dashboard.firebaseapp.com",
    databaseURL: "https://epiroc-dashboard-default-rtdb.firebaseio.com",
    projectId: "epiroc-dashboard",
    storageBucket: "epiroc-dashboard.firebasestorage.app",
    messagingSenderId: "453253762574",
    appId: "1:453253762574:web:80de8eaace834aa122765f",
    measurementId: "G-DZ5VYPQ9T1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const parkImg = document.getElementById("park-img");
const checkEngine = document.getElementById("check-engine");
const motorStatus = document.getElementById("motor-status");
const batteryLow = document.getElementById("battery-low");
const plugin = document.getElementById("plugin");

//const batteryCharge=0;

// Function to fetch and process data
async function fetchAndDisplayData() {
    try {
        const response = await fetch("https://firestore.googleapis.com/v1/projects/epiroc-dashboard/databases/(default)/documents/dashboard");
        const data = await response.json();
      // Fetch data from database
        const batteryCharge = data.documents[0]?.fields?.battery_charge?.integerValue || "N/A";
        const parking = data.documents[0]?.fields?.parking?.booleanValue || false;
        const checkengine = data.documents[0]?.fields?.engine_status?.booleanValue || false;
        const motorstatus = data.documents[0]?.fields?.motor_status?.booleanValue || false;
        const batterylow = data.documents[0]?.fields?.battery_low?.booleanValue || false;
        const gearratio = data.documents[0]?.fields?.gear_ratio?.stringValue || "N/N";
        const rpmValue = data.documents[0]?.fields?.rpm?.stringValue || "0";
        const temp = data.documents[0]?.fields?.battery_temprature?.integerValue || "0";
        // Update the parking image based on the parking status
        
       
        parkImg.src = parking ? "images/park.PNG" : "images/park-disabled.PNG";
        checkEngine.src = checkengine ? "images/check-engine.png" : "images/check-disabled.png";
       
        if (motorstatus) {
          motorStatus.src = "images/power.png"; // Change to 'no-parking' image
          motorStatus.classList.add("blink-image"); // Add blinking effect
        } else {
          
          motorStatus.src = "images/power-disabled.png"; // Change to 'parking-available' image
          motorStatus.classList.remove("blink-image"); // Remove blinking effect
        }
        if (batterylow) {
          batteryLow.src = "images/battery.png"; // Change to 'no-parking' image
          batteryLow.classList.add("blink-image"); // Add blinking effect
        } else {
          batteryLow.src = "images/battery-disabled.png"; // Change to 'parking-available' image
          batteryLow.classList.remove("blink-image"); // Remove blinking effect
        }
       
        updateBattery(batteryCharge);
        // Update the battery charge in HTML
        document.getElementById("gear_ratio").innerHTML = gearratio;
        document.getElementById("percent").innerHTML = batteryCharge;
        document.getElementById("rpm").innerHTML = rpmValue +'RPM';
        document.getElementById("temp").innerHTML = temp;
        document.getElementById("animated-slider").value = rpmValue;
        gauge2.value=rpmValue;
        gauge2.update();
        var power=rpmValue*22*0.018;
        gauge.value = power;
        gauge.update();

     
    } catch (error) {
        console.error("Error fetching data:", error);
    }
}

function updateBattery(percentage) {
  const blocks = document.querySelectorAll('.battery-block');
  const activeBlocks = Math.ceil((percentage / 100) * blocks.length);

  blocks.forEach((block, index) => {
    if (index < activeBlocks) {
      block.classList.add('active');
      block.classList.remove('hide');
    } else {
      block.classList.remove('active');
      block.classList.add('hide');
    }
  });
}

// Example usage
 // Show 60% battery


// Real-time updates
function listenToRealtimeUpdates() {
    const collectionRef = collection(db, "dashboard");
    onSnapshot(collectionRef, (snapshot) => {
        let batteryCharge = "0";
        let batterylow = false;
        let parking = false;
        let checkeng=false;
        let gear_ratio='N/N';
        let rpmValue=0;
        let motorstatus=false;
        let batteryTemprature=0;
        snapshot.forEach(doc => {
           if (doc.data().battery_low) {
              batterylow = doc.data().battery_low;
            }
            if (doc.data().battery_charge) {
                batteryCharge = doc.data().battery_charge;
            }
            if (doc.data().parking !== undefined) {
              parking = doc.data().parking;
            }
            if (doc.data().engine_status !== undefined) {
              checkeng = doc.data().engine_status;
            }
            if (doc.data().gear_ratio !== undefined) {
              gear_ratio = doc.data().gear_ratio;
            }
            if (doc.data().rpm !== undefined) {
              rpmValue = doc.data().rpm;
            }
            if (doc.data().motor_status !== undefined) {
              motorstatus = doc.data().motor_status;
            }

            if (doc.data().battery_temprature !== undefined) {
              batteryTemprature = doc.data().battery_temprature;
            }
        });
        
        updateBattery(batteryCharge);

        // Update the battery charge in HTML
        document.getElementById("gear_ratio").innerHTML =gear_ratio;
        document.getElementById("percent").innerText = batteryCharge;
        document.getElementById("rpm").innerHTML = rpmValue +' RPM';
        document.getElementById("temp").innerHTML = batteryTemprature;

        parkImg.src = parking ? "images/park.PNG" : "images/park-disabled.PNG";
        checkEngine.src = checkeng ? "images/check-engine.png" : "images/check-disabled.png";
  
       
        if (motorstatus== true) {
          motorStatus.src = "images/power.png"; // Change to 'no-parking' image
          motorStatus.classList.add("blink-image"); // Add blinking effect
        } else {
          
          motorStatus.src = "images/power-disabled.png"; // Change to 'parking-available' image
          motorStatus.classList.remove("blink-image"); // Remove blinking effect
        }
        if (batterylow==true) {
          batteryLow.src = "images/battery.png"; // Change to 'no-parking' image
          batteryLow.classList.add("blink-image"); // Add blinking effect
        } else {
          batteryLow.src = "images/battery-disabled.png"; // Change to 'parking-available' image
          batteryLow.classList.remove("blink-image"); // Remove blinking effect
        }
           
    });
}



// Initialize the app
document.addEventListener("DOMContentLoaded", () => {

    fetchAndDisplayData();
    listenToRealtimeUpdates();
});


// Slider for RPM
var speedoMeterInputRange = document.getElementById('animated-slider');
var speedoMeterInputRangeVal = document.getElementById('speedoMeterInputRange-value-1');
let timeoutId; 
let timeout;

//Function for battery charging
function increaseBatteryLevel() {
  var batteryLevel= parseInt($("#percent").html());
  const blocks = document.querySelectorAll('.battery-block');
  //alert(batteryLevel);
if (batteryLevel < 100) { // Ensure the battery does not exceed 100%
  batteryLevel = batteryLevel+1;
  updateBattery(batteryLevel);
  let batteryLow = batteryLevel < 20 ? true : false;
  //blocks.style.height = `${batteryLevel}%`; // Update the height
  //batteryPercentage.textContent = `${batteryLevel}%`; // Update the text
  const docRef = doc(db, "dashboard", "vehicle_data");
          // Update the "battery_ch.rge" field
           updateDoc(docRef, {
              battery_charge: batteryLevel,
              battery_low:batteryLow
             
          });
}
}

function handleClick() {
  const blocks = document.querySelectorAll('.battery-block');
  var charge_state=false;
// Add the "animate" class to each block
blocks.forEach(block => {
  if (block.classList.contains('animate')) {
   
      block.classList.remove('animate');
       plugin.src="images/plugin-disabled.png";
      // Increase battery level every 30 seconds
      document.getElementById("animated-slider").disabled = false;
      gauge.value=0;
      gauge.update();
      clearInterval(timeoutId);
      charge_state=false;
    } else {
    document.getElementById("animated-slider").value = 0;
   
    document.getElementById("animated-slider").dispatchEvent(new Event('change'));
    document.getElementById("animated-slider").disabled = true;
    block.classList.add('animate'); 
    plugin.src="images/plugin.png";
      
      if (timeoutId) {
      clearInterval(timeoutId);
      console.log("Previous interval cleared.");
    }
      timeoutId = setInterval(increaseBatteryLevel, 5000);
      gauge.value=-100;
      gauge.update()
      charge_state=true;
    
        }

          const docRef = doc(db, "dashboard", "vehicle_data");
          // Update the "battery_ch.rge" field
           updateDoc(docRef, {
            charging_state: charge_state
             
          });
});
}

// Attach the function to the button
document.getElementById('plugin').onclick = handleClick;

function decreaseBatteryLevel() {
  var batteryLevel= parseInt($("#percent").html());
  
  //alert(batteryLevel);
if (batteryLevel > 0) { // Ensure the battery does not exceed 100%
  batteryLevel = batteryLevel-1;
  updateBattery(batteryLevel);
  let batteryLow = batteryLevel < 20 ? true : false;

  //blocks.style.height = `${batteryLevel}%`; // Update the height
  //batteryPercentage.textContent = `${batteryLevel}%`; // Update the text
  const docRef = doc(db, "dashboard", "vehicle_data");
          // Update the "battery_ch.rge" field
           updateDoc(docRef, {
              battery_charge: batteryLevel,
              battery_low:batteryLow
             
          });
}
}


speedoMeterInputRange.onchange = async function (e) {
  // Trigger the click event on the div with id="plugin"

  if(e.target.value==0)
    {
      clearInterval(timeout);

    }else{
      if (timeout) {
        clearInterval(timeout);
        console.log("Previous interval cleared.");
      }
      timeout = setInterval(decreaseBatteryLevel, 5000);
      
    } 

  gauge2.value=e.target.value;
  gauge2.update();
 
  const rpmValue=e.target.value;

  var power=Math.round(rpmValue*22*0.018);
  const tempIncreaseFactor = 0.01; // Adjust this factor as needed
  var batteryTemp= parseInt($("#temp").html());
  batteryTemp=(rpmValue*.1);


  gauge.value = power;
  gauge.update();
  //timeoutId = setInterval(decreaseBatteryLevel, 5000);

  
  const motorStatus = rpmValue > 600 ? true : false;
  try {
          // Reference to the Firestore document
          const docRef = doc(db, "dashboard", "vehicle_data");
          // Update the "battery_ch.rge" field
          await updateDoc(docRef, {
              // battery_charge: battery, // New value for battery_charge
              rpm: rpmValue,
              motor_status:motorStatus,
              // battery_low:batteryLow,
              power_comsumption:power,
              battery_temprature:batteryTemp
          });
    
      } catch (error) {
          console.error("Error updating document: ", error);
          
      }
    
    
}


</script>
</body>

</html>